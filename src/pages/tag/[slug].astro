---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { buildExcerpt, formatDate, slugToLabel, tagToSlug } from "../../lib/content";

interface Props {
  notes: CollectionEntry<"blog">[];
  label: string;
}

export async function getStaticPaths() {
  const notes = await getCollection("blog", ({ data }) => !data.draft);
  const map = new Map<string, { label: string; notes: CollectionEntry<"blog">[] }>();

  for (const note of notes) {
    for (const tag of note.data.tags) {
      const slug = tagToSlug(tag);
      const existing = map.get(slug);
      if (existing) {
        existing.notes.push(note);
      } else {
        map.set(slug, { label: tag, notes: [note] });
      }
    }
  }

  return [...map.entries()].map(([slug, value]) => ({
    params: { slug },
    props: {
      label: value.label,
      notes: value.notes.sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
    }
  }));
}

const { notes, label } = Astro.props as Props;
const heading = label || slugToLabel(Astro.params.slug ?? "");
const noteLabel = notes.length === 1 ? "note" : "notes";
---

<BaseLayout title={`Tag: ${heading}`} activePath="/">
  <section class="hero-plane hero-compact">
    <p class="eyebrow">Tag</p>
    <h1>#{heading}</h1>
    <p class="hero-copy">{notes.length} {noteLabel} tagged with #{heading}.</p>
  </section>

  <section class="note-stream">
    {notes.map((note) => (
      <article class="stream-item">
        <p class="stream-date">{formatDate(note.data.date)}</p>
        <div class="stream-main">
          <h3><a href={`/notes/${note.slug}/`}>{note.data.title}</a></h3>
          <p>{note.data.description ?? buildExcerpt(note.body, 180)}</p>
        </div>
      </article>
    ))}
  </section>
</BaseLayout>
