---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import projectsData from "../data/projects.json";

interface ProjectItem {
  slug?: string;
  name: string;
  image: string;
  url?: string;
  date?: string;
  tags?: string[];
}

const projectPages = await getCollection("project");
const internalBySlug = new Set(projectPages.map((entry) => entry.data.slug ?? entry.slug));
const projects = projectsData as ProjectItem[];

function summarizeProject(project: ProjectItem): string {
  if (!project.tags || project.tags.length === 0) {
    return "A practical build focused on solving a specific engineering problem.";
  }

  return `Built around ${project.tags.slice(0, 3).join(", ")} for production-minded workflows.`;
}
---

<BaseLayout title="Projects" activePath="/projects/">
  <section class="hero-plane hero-compact">
    <p class="eyebrow">Projects</p>
    <h1>Things I built to solve real problems</h1>
    <p class="hero-copy">
      These are selected builds across backend services, data pipelines,
      and internal tools. Each one started from a concrete need.
    </p>
  </section>

  <section class="project-lanes">
    {projects.map((project, index) => {
      const internalPath = project.slug ? `/projects/${project.slug}/` : null;
      const hasInternal = project.slug ? internalBySlug.has(project.slug) : false;
      const hasExternal = Boolean(project.url && project.url !== "#");
      const link = hasInternal ? internalPath : hasExternal ? project.url : null;
      const external = !hasInternal && hasExternal;

      return (
        <article class={`project-lane ${index % 2 === 1 ? "is-alt" : ""}`}>
          {link ? (
            <a
              class="lane-image-wrap"
              href={link}
              target={external ? "_blank" : undefined}
              rel={external ? "noopener noreferrer" : undefined}
            >
              <img class="lane-image" src={`/static/projects/${project.image}`} alt={project.name} loading="lazy" />
            </a>
          ) : (
            <div class="lane-image-wrap is-static">
              <img class="lane-image" src={`/static/projects/${project.image}`} alt={project.name} loading="lazy" />
            </div>
          )}

          <div class="lane-body">
            <p class="note-meta">{project.date ?? "In progress"}</p>
            <h3>
              {link ? (
                <a href={link} target={external ? "_blank" : undefined} rel={external ? "noopener noreferrer" : undefined}>
                  {project.name}
                </a>
              ) : (
                project.name
              )}
            </h3>

            <p>{summarizeProject(project)}</p>

            <div class="chip-row">
              {(project.tags ?? []).map((tag) => (
                <span class="chip">{tag}</span>
              ))}
            </div>

            <div class="lane-actions">
              {link ? (
                <a href={link} target={external ? "_blank" : undefined} rel={external ? "noopener noreferrer" : undefined}>
                  {external ? "Visit project" : "Read case study"}
                </a>
              ) : (
                <span>Case study coming soon</span>
              )}
            </div>
          </div>
        </article>
      );
    })}
  </section>
</BaseLayout>
