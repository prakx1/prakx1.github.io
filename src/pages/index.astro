---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import { buildExcerpt, categoryToSlug, formatDate, tagToSlug } from "../lib/content";

const notes = (await getCollection("blog", ({ data }) => !data.draft)).sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);

const categories = [...new Set(notes.flatMap((note) => note.data.categories))];
const tags = [...new Set(notes.flatMap((note) => note.data.tags ?? []))];
const latest = notes[0];
---

<BaseLayout activePath="/">
  <section class="hero-plane">
    <p class="eyebrow">Personal engineering notebook</p>
    <p class="hero-copy">
      I use this space to share what I build, what I think, and what I test.
    </p>

    <div class="hero-actions">
      {latest && <a class="button-main" href={`/notes/${latest.slug}/`}>Start with latest note</a>}
      <a class="button-subtle" href="/projects/">Browse projects</a>
    </div>

    <dl class="hero-stats">
      <div>
        <dt>{notes.length}</dt>
        <dd>Notes</dd>
      </div>
      <div>
        <dt>{tags.length || categories.length}</dt>
        <dd>Tags in use</dd>
      </div>
      <div>
        <dt>{latest ? formatDate(latest.data.date) : "Soon"}</dt>
        <dd>Last publish</dd>
      </div>
    </dl>
  </section>

  <section class="stream-header">
    <h2>Recent Entries</h2>
    <a href="/feed.xml">RSS feed</a>
  </section>

  <section class="note-stream" aria-label="Blog notes">
    {notes.map((note) => (
      <article class="stream-item">
        <p class="stream-date">{formatDate(note.data.date)}</p>
        <div class="stream-main">
          <h3>
            <a href={`/notes/${note.slug}/`}>{note.data.title}</a>
          </h3>
          <p>{note.data.description ?? buildExcerpt(note.body, 195)}</p>
          <div class="chip-row">
            {note.data.categories.slice(0, 3).map((category) => (
              <a class="chip" href={`/category/${categoryToSlug(category)}/`}>
                {category}
              </a>
            ))}
          </div>
          {note.data.tags.length > 0 && (
            <div class="chip-row chip-row-secondary">
              {note.data.tags.slice(0, 4).map((tag) => (
                <a class="chip chip-tag" href={`/tag/${tagToSlug(tag)}/`}>
                  #{tag}
                </a>
              ))}
            </div>
          )}
        </div>
      </article>
    ))}
  </section>
</BaseLayout>
